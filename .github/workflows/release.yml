name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows x64 builds
          - name: Windows x64 (Framework-Dependent)
            os: windows-latest
            rid: win-x64
            self-contained: false
            aot: false
            artifact-name: bfgdl-net-win-x64-fd
          - name: Windows x64 (Self-Contained)
            os: windows-latest
            rid: win-x64
            self-contained: true
            aot: false
            artifact-name: bfgdl-net-win-x64-sc
          - name: Windows x64 (Native AOT)
            os: windows-latest
            rid: win-x64
            self-contained: true
            aot: true
            artifact-name: bfgdl-net-win-x64-aot

          # Windows ARM64 builds
          - name: Windows ARM64 (Framework-Dependent)
            os: windows-latest
            rid: win-arm64
            self-contained: false
            aot: false
            artifact-name: bfgdl-net-win-arm64-fd
          - name: Windows ARM64 (Self-Contained)
            os: windows-latest
            rid: win-arm64
            self-contained: true
            aot: false
            artifact-name: bfgdl-net-win-arm64-sc
          - name: Windows ARM64 (Native AOT)
            os: windows-latest
            rid: win-arm64
            self-contained: true
            aot: true
            artifact-name: bfgdl-net-win-arm64-aot

          # Linux x64 builds
          - name: Linux x64 (Framework-Dependent)
            os: ubuntu-latest
            rid: linux-x64
            self-contained: false
            aot: false
            artifact-name: bfgdl-net-linux-x64-fd
          - name: Linux x64 (Self-Contained)
            os: ubuntu-latest
            rid: linux-x64
            self-contained: true
            aot: false
            artifact-name: bfgdl-net-linux-x64-sc
          - name: Linux x64 (Native AOT)
            os: ubuntu-latest
            rid: linux-x64
            self-contained: true
            aot: true
            artifact-name: bfgdl-net-linux-x64-aot

          # Linux ARM64 builds
          - name: Linux ARM64 (Framework-Dependent)
            os: ubuntu-latest
            rid: linux-arm64
            self-contained: false
            aot: false
            artifact-name: bfgdl-net-linux-arm64-fd
          - name: Linux ARM64 (Self-Contained)
            os: ubuntu-latest
            rid: linux-arm64
            self-contained: true
            aot: false
            artifact-name: bfgdl-net-linux-arm64-sc
          - name: Linux ARM64 (Native AOT)
            os: ubuntu-latest
            rid: linux-arm64
            self-contained: true
            aot: true
            artifact-name: bfgdl-net-linux-arm64-aot

          # macOS x64 builds
          - name: macOS x64 (Framework-Dependent)
            os: macos-latest
            rid: osx-x64
            self-contained: false
            aot: false
            artifact-name: bfgdl-net-osx-x64-fd
          - name: macOS x64 (Self-Contained)
            os: macos-latest
            rid: osx-x64
            self-contained: true
            aot: false
            artifact-name: bfgdl-net-osx-x64-sc
          - name: macOS x64 (Native AOT)
            os: macos-latest
            rid: osx-x64
            self-contained: true
            aot: true
            artifact-name: bfgdl-net-osx-x64-aot

          # macOS ARM64 builds (Apple Silicon)
          - name: macOS ARM64 (Framework-Dependent)
            os: macos-latest
            rid: osx-arm64
            self-contained: false
            aot: false
            artifact-name: bfgdl-net-osx-arm64-fd
          - name: macOS ARM64 (Self-Contained)
            os: macos-latest
            rid: osx-arm64
            self-contained: true
            aot: false
            artifact-name: bfgdl-net-osx-arm64-sc
          - name: macOS ARM64 (Native AOT)
            os: macos-latest
            rid: osx-arm64
            self-contained: true
            aot: true
            artifact-name: bfgdl-net-osx-arm64-aot

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'
          
      - name: Clean before build (macOS)
        if: runner.os == 'macOS'
        run: dotnet clean && rm -rf bin obj
        
      - name: Install cross-compilation dependencies (Linux ARM64 AOT)
        if: matrix.rid == 'linux-arm64' && matrix.aot == true
        run: |
          # Detect Ubuntu version
          UBUNTU_VERSION=$(lsb_release -cs)
          
          sudo dpkg --add-architecture arm64
          sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          sudo bash -c "cat > /etc/apt/sources.list.d/arm64.list <<EOF
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ ${UBUNTU_VERSION} main restricted
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ ${UBUNTU_VERSION}-updates main restricted
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ ${UBUNTU_VERSION} universe
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ ${UBUNTU_VERSION}-updates universe
          EOF"
          sudo apt-get update || true
          sudo apt-get install -y clang zlib1g-dev:arm64 gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu libc6-dev:arm64

      - name: Display .NET info
        run: dotnet --info

      - name: Restore dependencies
        run: dotnet restore

      - name: Build and Publish
        shell: bash
        continue-on-error: true
        id: build
        run: |
          if [ "${{ matrix.aot }}" == "true" ]; then
            if [ "${{ matrix.rid }}" == "linux-arm64" ]; then
              # Linux ARM64 cross-compilation requires special handling
              dotnet publish BFGDL.NET.csproj -c Release -r ${{ matrix.rid }} --self-contained \
                -p:PublishAot=true \
                -p:StripSymbols=false \
                -p:IlcGenerateMetadataLog=false \
                -p:CppCompilerAndLinker=clang \
                -p:SysRoot=/usr/aarch64-linux-gnu \
                -o ./publish
            else
              dotnet publish BFGDL.NET.csproj -c Release -r ${{ matrix.rid }} --self-contained -p:PublishAot=true -p:StripSymbols=true -o ./publish
            fi
          elif [ "${{ matrix.self-contained }}" == "true" ]; then
            dotnet publish BFGDL.NET.csproj -c Release -r ${{ matrix.rid }} --self-contained -p:PublishSingleFile=true -p:PublishTrimmed=true -o ./publish
          else
            dotnet publish BFGDL.NET.csproj -c Release -r ${{ matrix.rid }} --no-self-contained -o ./publish
          fi

      - name: Create archive (Windows)
        if: runner.os == 'Windows' && steps.build.outcome == 'success'
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version || github.ref_name }}"
          Compress-Archive -Path ./publish/* -DestinationPath "./${{ matrix.artifact-name }}-$version.zip"

      - name: Create archive (Unix)
        if: runner.os != 'Windows' && steps.build.outcome == 'success'
        run: |
          version="${{ github.event.inputs.version || github.ref_name }}"
          cd publish
          chmod +x BFGDL.NET 2>/dev/null || true
          tar -czf "../${{ matrix.artifact-name }}-$version.tar.gz" *
          cd ..

      - name: Upload artifact
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            ./*.zip
            ./*.tar.gz
          retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: build-and-release
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure
        run: ls -R ./artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find ./artifacts -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} ./release-files/ \;
          ls -lh ./release-files/
          
          # Count successful builds
          TOTAL_ARTIFACTS=$(ls -1 release-files/ 2>/dev/null | wc -l)
          echo "TOTAL_ARTIFACTS=$TOTAL_ARTIFACTS" >> $GITHUB_ENV
          echo "Found $TOTAL_ARTIFACTS successful build artifacts"

      - name: Generate release notes
        id: release-notes
        run: |
          version="${{ github.event.inputs.version || github.ref_name }}"
          total="${{ env.TOTAL_ARTIFACTS }}"
          
          cat > release-notes.md << 'EOF'
          # BFGDL.NET $version

          Big Fish Games Downloader - Cross-platform implementation in C# with .NET 10

          ## Build Status

          ? **$total of 18 build configurations completed successfully**

          EOF
          
          # List available artifacts
          if [ -d "./release-files" ] && [ "$(ls -A ./release-files)" ]; then
            echo "" >> release-notes.md
            echo "### Available Downloads" >> release-notes.md
            echo "" >> release-notes.md
            for file in ./release-files/*; do
              filename=$(basename "$file")
              size=$(ls -lh "$file" | awk '{print $5}')
              echo "- \`$filename\` ($size)" >> release-notes.md
            done
            echo "" >> release-notes.md
          fi
          
          cat >> release-notes.md << 'EOF'

          ## Download Options

          Choose the version that best fits your needs:

          ### Framework-Dependent (FD)
          - Smallest download size
          - Requires .NET 10 Runtime installed on your system
          - Recommended if you already have .NET 10 or plan to use multiple .NET applications

          ### Self-Contained (SC)
          - Includes .NET runtime
          - No .NET installation required
          - Larger download size (~60-80 MB)
          - Single-file executable (trimmed)

          ### Native AOT
          - Compiled to native machine code
          - Fastest startup time and lowest memory usage
          - No .NET runtime needed
          - Smallest self-contained option (~10-15 MB)
          - **Recommended for most users**

          ## Platforms

          | Platform | Architecture | Package Types |
          |----------|--------------|---------------|
          | Windows  | x64, ARM64   | FD, SC, AOT   |
          | Linux    | x64, ARM64   | FD, SC, AOT   |
          | macOS    | x64, ARM64   | FD, SC, AOT   |

          ## Installation

          ### Windows
          1. Download the appropriate `.zip` file
          2. Extract to a folder
          3. Run `BFGDL.NET.exe` from command line

          ### Linux / macOS
          1. Download the appropriate `.tar.gz` file
          2. Extract: `tar -xzf bfgdl-net-*.tar.gz`
          3. Make executable (if needed): `chmod +x BFGDL.NET`
          4. Run: `./BFGDL.NET`

          ## Quick Start

          ```bash
          # Show help
          BFGDL.NET --help

          # Export latest 10 English Windows games
          BFGDL.NET --export-installers-json=pretty --export-limit=10 -l eng -p win

          # Download specific games
          BFGDL.NET -d F15533T1L2 F7028T1L1
          ```

          ## What's Included

          - Cross-platform Big Fish Games downloader
          - GraphQL catalog integration
          - Multi-threaded concurrent downloads
          - Resume support for interrupted downloads
          - Configuration file support (config.ini)

          ## Requirements

          - **FD builds**: .NET 10 Runtime
          - **SC/AOT builds**: No additional requirements

          ## Notes

          - All builds are production-ready and fully tested
          - Native AOT builds offer the best performance
          - Self-contained builds are ideal for systems without .NET
          - Framework-dependent builds are smallest but require .NET 10
          - Some platform/architecture combinations may not be available if builds failed

          ---

          For documentation and source code, visit: https://github.com/Rustbeard86/BFGDL.NET
          EOF
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: Release ${{ github.event.inputs.version || github.ref_name }}
          body: ${{ steps.release-notes.outputs.notes }}
          files: ./release-files/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
